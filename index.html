<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>D3 + Supabase Example</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

</head>
<body>
  <h1>Supabase Data with D3</h1>
  <div id="chart"></div>

  <script>
    // Initialize Supabase client

 var nodes = [];
  var mapNodes; // key,value lookup dict

class MyNode {
    
    constructor(d) {
            this.NODE_ID = d.NODE_ID;
            this.NODE_TXT = d.NODE_TXT;
            this.LAST_MOD_TS = d.LAST_MOD_TS;
            // this.label = `${this.NODE_ID} = ${this.NODE_TXT}`;
    }

    label() {
        return `${this.NODE_ID} = ${this.NODE_TXT}`;
    }
}




  function NodeInfo(d) {
    if ( d.NODE_TXT ) {
        return d.NODE_TXT.replace(/\|/g,'\n');
    }
}

function IsRoundedShape(d) {
    // for now, all nodes are circles
    return true;
}

function AppendShapes(rs) {
    nodes = rs; // the 'master' array used by d3 to render shapes
    // we also want to access each datum via its unique NODE_ID string
    mapNodes = new Map ( nodes.map((x,i) => ( [x.NODE_ID, x ]) ) );
  // console.log(mapNodes);  
    // create the SVG visual element
    gNode.selectAll('circle') // in case we've already got some
        .data(nodes.filter(IsRoundedShape)) // see comment above - how best to hide a circle when its group is visible and vice versa
            .join('circle')  // append a new circle shape bound to that datum
                // .on('mouseover',handleMouseOverNode) // for popup if implemented
                // .on('mouseout',handleMouseOutNode)
                // .on('click',handleClickNode)
                // .on('dblclick',handleDblClickNode)
                // .attr('r',NodeRadius)
                // .attr('fill',NodeColour)
                // .append('title') // auto tooltip lacks the option to set format with CSS - not even font size
                // can we append a custom element that supports CSS eg (stackoverflow)
                .text(NodeInfo)
                ;
}


    const supabaseClient = supabase.createClient(
      APP_CONFIG.supabaseUrl,
      APP_CONFIG.supabaseAnonKey
  );

async function loadData() { // must be async, to allow "await"
      
      nodes_promise = supabaseClient 
        .from("nodes")
        .select("*");

      edges_promise = supabaseClient 
        .from("edges")
        .select("*");
        
//  destructure the results & rename for clarity
let { data : nodes,  error: node_error } = await nodes_promise; 

      if (node_error) {
        console.error(node_error);
        return;
      }

      nodes = nodes.map(obj => new MyNode(obj));

      AppendShapes(nodes);

let { data: edges, error: edge_error } = await edges_promise; 

      if (edge_error) {
        console.error(edge_error);
        return;
      }

      // Use d3 to bind data
      d3.select("#chart")
        .selectAll("p") // DOM elements in scope
        .data(nodes)
        .enter() // anti-join: "new" nodes = those not currently bound to any of these in-scope "p" elements
        .append("p") // create a new element for each not found
        .text(d => d.label());

    console.log(nodes);
   // console.log(edges);



    }


async function TestUpdate() {

let update_promise  = supabaseClient
  .from('nodes')
  .update({ LAST_MOD_TS: new Date().toISOString() })
  .eq('NODE_ID', 'XXX')
  .select();

const { data: u_data, error: e } = await update_promise; 

   console.log(u_data);
}



      var width = window.innerWidth, height = window.innerHeight;
      console.log(`width=${width} height=${height}`);


         var svg = d3.select('body').append('svg')
                .attr('width',width)
                .attr('height',height)
                // set origin to centre of svg
                .attr('viewBox', [-500, -500, 1000, 1000] ) // case-sensitive attribute name !!
                // interesting behaviour when window resizes - ALMOST good
                .attr('style', 'max-width:100%; height:auto; height:intrinsic;')

            const gNode = svg.append("g"); // involved parties

loadData(); // no "await" therefore returns a promise

// TestUpdate() ;



  </script>
</body>
</html>
